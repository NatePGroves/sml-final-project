knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(corrplot)
library(car)
library(boot)
library(leaps)
library(glmnet)
library(tree)
library(pls)
libraries <- read_csv("../data/libraries.csv")
# Function to remove outliers using the IQR rule
remove_outliers <- function(x) {
if (is.numeric(x) && length(unique(na.omit(x))) > 2) {  # skip binary
q1 <- quantile(x, 0.25, na.rm = TRUE)
q3 <- quantile(x, 0.75, na.rm = TRUE)
iqr <- q3 - q1
lower <- q1 - 1.5 * iqr
upper <- q3 + 1.5 * iqr
x[x < lower | x > upper] <- NA  # mark outliers
}
return(x)
}
# Columns to ignore
ignore_cols <- c("Bookmobiles", "Branch Library", "state")
# Apply only to numeric, non-binary, and not ignored columns
libraries <- libraries %>%
mutate(across(
.cols = where(is.numeric) & !all_of(ignore_cols),
.fns = remove_outliers
)) %>%
drop_na()
# Count occurrences per state
state_counts <- table(libraries$state)
# Find states with < 20 occurrences
rare_states <- names(state_counts[state_counts < 20])
# Combine them into "Other" (this is for CV purposes)
libraries$state <- as.character(libraries$state)
libraries$state[libraries$state %in% rare_states] <- "Other"
libraries$state <- factor(libraries$state)  # re-factor to clean up
# Do the same for testing data:
library_testing <- read_csv("../data/libraries_testing.csv")
library_testing$state <- as.character(library_testing$state)
library_testing$state[library_testing$state %in% rare_states] <- "Other"
library_testing$state[!(library_testing$state %in% libraries$state)] <- "Other"
library_testing$state <- factor(library_testing$state)  # re-factor to clean up
libraries <- libraries %>%
mutate(across(where(is.character), as.factor))
library_testing <- library_testing %>%
mutate(across(where(is.character), as.factor))
full.library.model <- glm(`Total Circulation` ~ ., data = libraries, family = "gaussian")
summary(full.library.model)
best.stepwise.model <- glm(formula = `Total Circulation` ~ state + Locale + `Service Area Population` +
`Percentage of Children's Material Circulation` + `Branch Library` +
`Internet Computers` + `Wireless Sessions` + `Children's Program Attendance` +
`Local Revenue ($)` + `State Revenue ($)` + `Hours/Year` +
`Physical Visits` + `Registered Users` + `Inter-library Loans from Other Library`,
data = libraries, family = "gaussian")
set.seed(13)
cv.glm(libraries, best.stepwise.model, K=100)$delta[2]
set.seed(13)
cv.glm(libraries, full.library.model, K=100)$delta[2]
libraries.X <- model.matrix(full.library.model)[,-1]
libraries.Y <- full.library.model$data$`Total Circulation`
#lets use cross validation and get a ridge and LASSO model
set.seed(4545)
libraries.ridge <- cv.glmnet(x = libraries.X, y=libraries.Y, alpha=0)
plot(libraries.ridge) # 9 recommended for ridge
set.seed(4545)
libraries.lasso <- cv.glmnet(x = libraries.X, y=libraries.Y, alpha=1)
plot(libraries.lasso) # 7 recommended for LASSO
set.seed(4545)
libraries.tree.data <- libraries
names(libraries.tree.data) <- make.names(names(libraries.tree.data))
tree.libraries <- tree(Total.Circulation ~ . , data = libraries.tree.data)
set.seed(4545)
cv.tree.libraries <- cv.tree(tree.libraries, K = 10)
which(min(cv.tree.libraries$dev) == cv.tree.libraries$dev)
cv.tree.libraries$size[1] # The cross validation pruning recommends 8 terminal nodes
which(min(cv.tree.libraries$dev) == cv.tree.libraries$dev)
cv.tree.libraries$size[1] # The cross validation pruning recommends 8 terminal nodes
set.seed(4545)
libraries.tree.data <- libraries
names(libraries.tree.data) <- make.names(names(libraries.tree.data))
tree.libraries <- tree(Total.Circulation ~ . , data = libraries.tree.data)
set.seed(4545)
cv.tree.libraries <- cv.tree(tree.libraries, K = 10)
which(min(cv.tree.libraries$dev) == cv.tree.libraries$dev)
cv.tree.libraries$size[1] # The cross validation pruning recommends 8 terminal nodes
par(mfrow = c(1, 2))
plot(cv.tree.libraries$size, cv.tree.libraries$dev, type = "b")
plot(cv.tree.libraries$k, cv.tree.libraries$dev, type = "b")
four.leaf.tree <- prune.tree(tree.libraries, best = 4)
eight.leaf.tree <- prune.tree(tree.libraries, best = 8)
libraries.plsr <- plsr(`Total Circulation` ~ ., data=libraries, scale=T, validation="CV")
sapply(libraries, function(x) length(unique(x)))
summary(libraries.plsr)
validationplot(libraries.plsr)
# 15 comps for minimum adjusted RMSE, but I think that we could less, maybe 11
full.predictions <- predict(full.library.model, newdata = library_testing, type = "response")
full.residuals <- library_testing$`Total Circulation` - full.predictions
stepwise.predictions <- predict(best.stepwise.model, newdata = library_testing, type = "response")
stepwise.residuals <- library_testing$`Total Circulation` - stepwise.predictions
full.MSE <- mean((full.residuals)^2)
stepwise.MSE <- mean((stepwise.residuals)^2)
print(c(full.MSE, stepwise.MSE))
X.test <- model.matrix(`Total Circulation` ~ ., data = library_testing)[, -1]
Y.test = library_testing$`Total Circulation`
ridge.predictions = predict(libraries.ridge, newx = X.test, s = 9)
lasso.predictions = predict(libraries.lasso, newx = X.test, s = 7)
# fix the testing names so they work for the tree:
libraries.tree.testing.data <- library_testing
names(libraries.tree.testing.data) <- make.names(names(library_testing))
four.leaf.predictions <- predict(four.leaf.tree, newdata = libraries.tree.testing.data)
eight.leaf.predictions <- predict(eight.leaf.tree, newdata = libraries.tree.testing.data)
plsr.predictions.15.comp <- predict(libraries.plsr, newdata = X.test, ncomp = 15)
plsr.predictions.11.comp <- predict(libraries.plsr, newdata = X.test, ncomp = 11)
four.leaf.predictions
library(sjPlot)
full.library.model$coefficients
plot(full.library.model$coefficients)
full.model.coeff <- full.library.model$coefficients
full.model.coeff <- as.data.fram(full.library.model$coefficients)
full.model.coeff <- as.data.frame(full.library.model$coefficients)
full.model.coeff
full.model.coeff <- colnames(c(Variable, Coefficient))
full.model.coeff <- colnames(c("Variable", "Coefficient"))
full.model.coeff
full.model.coeff
full.model.coeff <- as.data.frame(full.library.model$coefficients)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(full.model.coeff[1], full.model.coeff[2]))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(full.model.coeff[1,], full.model.coeff[2,]))
colnames(full.model.coeff) <- c("Variable", "Coefficient")
full.model.coeff
full.model.coeff <- as.tibble(full.library.model$coefficients)
full.model.coeff
full.library.model$coefficients
summary(full.library.model)
full.model.coeff <- as.tibble(full.library.model$coefficients)|>
names(libraries)
names(libraries)
full.model.coeff$Variable <-   names(libraries)
summary(full.library.model)
full.model.coeff
full.model.coeff$Variable <-names(libraries)
names(libraries)
summary(full.library.model)
full.model.coeff$Variable <-names(full.library.model)
names(full.library.model)
full.model.coeff <- as.data.frame(full.library.model$coefficients)
full.model.coeff
ggplot(full.model.coeff)+
geom_bar()
full.model.coeff$Variable <- c((Intercept),
stateAL,
stateCO,
stateIA,
stateID,
stateIL,
stateIN,
stateKS,
stateKY,
stateMA,
stateME,
stateMI,
stateMN,
stateMO,
stateMT,
stateND,
stateNE,
stateNH,
stateNJ,
stateNM,
stateNY,
stateOK,
stateOther,
statePA,
stateSD,
stateTN,
stateTX,
stateVT,
stateWI,
LocaleRural,
LocaleSuburban,
LocaleTown,
`Service Area Population`,
`Percentage of Children's Material Circulation`,
`Central Library`,
`Branch Library`,
Bookmobiles,
`Internet Computers`,
`Computer Uses`,
`Wireless Sessions`,
`Children's Programs`,
`Young Adult Programs`,
`Adult Programs`,
`Children's Program Attendance`,
`Adult Program Attendance`,
`General Interest Program Attendance`,
`General Interest Programs`,
`Local Revenue ($)`,
`State Revenue ($)`,
`Federal Revenue ($)`,
`Other Revenue ($)`,
`Hours/Year`,
`Physical Visits`,
`Reference Transactions`,
`Registered Users`,
`Inter-library Loans to Other Library`,
`Inter-library Loans from Other Library`)
full.model.coeff$Variable <- c((Intercept,stateAL,stateCO,stateIA,stateID,stateIL,stateIN,stateKS,stateKY,stateMA,stateME,stateMI,stateMN,stateMO,stateMT,stateND,stateNE,stateNH,stateNJ,stateNM,stateNY,stateOK,stateOther,statePA,stateSD,stateTN,stateTX,stateVT,stateWI,LocaleRural,LocaleSuburban,LocaleTown,`Service Area Population`,`Percentage of Children's Material Circulation`,`Central Library`,`Branch Library`,Bookmobiles,`Internet Computers`,`Computer Uses`,`Wireless Sessions`,`Children's Programs`,`Young Adult Programs`,`Adult Programs`,`Children's Program Attendance`,`Adult Program Attendance`,`General Interest Program Attendance`,`General Interest Programs`,`Local Revenue ($)`,`State Revenue ($)`,`Federal Revenue ($)`,`Other Revenue ($)`,`Hours/Year`,`Physical Visits`,`Reference Transactions`,`Registered Users`,`Inter-library Loans to Other Library`,`Inter-library Loans from Other Library`)
full.model.coeff$Variable <- c(Intercept,stateAL,stateCO,stateIA,stateID,stateIL,stateIN,stateKS,stateKY,stateMA,stateME,stateMI,stateMN,stateMO,stateMT,stateND,stateNE,stateNH,stateNJ,stateNM,stateNY,stateOK,stateOther,statePA,stateSD,stateTN,stateTX,stateVT,stateWI,LocaleRural,LocaleSuburban,LocaleTown,`Service Area Population`,`Percentage of Children's Material Circulation`,`Central Library`,`Branch Library`,Bookmobiles,`Internet Computers`,`Computer Uses`,`Wireless Sessions`,`Children's Programs`,`Young Adult Programs`,`Adult Programs`,`Children's Program Attendance`,`Adult Program Attendance`,`General Interest Program Attendance`,`General Interest Programs`,`Local Revenue ($)`,`State Revenue ($)`,`Federal Revenue ($)`,`Other Revenue ($)`,`Hours/Year`,`Physical Visits`,`Reference Transactions`,`Registered Users`,`Inter-library Loans to Other Library`,`Inter-library Loans from Other Library`)
full.model.coeff$Variable <- c("Intercept",stateAL,stateCO,stateIA,stateID,stateIL,stateIN,stateKS,stateKY,stateMA,stateME,stateMI,stateMN,stateMO,stateMT,stateND,stateNE,stateNH,stateNJ,stateNM,stateNY,stateOK,stateOther,statePA,stateSD,stateTN,stateTX,stateVT,stateWI,LocaleRural,LocaleSuburban,LocaleTown,`Service Area Population`,`Percentage of Children's Material Circulation`,`Central Library`,`Branch Library`,Bookmobiles,`Internet Computers`,`Computer Uses`,`Wireless Sessions`,`Children's Programs`,`Young Adult Programs`,`Adult Programs`,`Children's Program Attendance`,`Adult Program Attendance`,`General Interest Program Attendance`,`General Interest Programs`,`Local Revenue ($)`,`State Revenue ($)`,`Federal Revenue ($)`,`Other Revenue ($)`,`Hours/Year`,`Physical Visits`,`Reference Transactions`,`Registered Users`,`Inter-library Loans to Other Library`,`Inter-library Loans from Other Library`)
full.model.coeff
coef_df <- data.frame(
term = names(full.library.model$coefficients),
estimate = full.library.model$coefficients
)
full.model.coeff <- data.frame(
term = names(full.library.model$coefficients),
estimate = full.library.model$coefficients)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term,estimate))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(estimate))
ggplot(full.model.coeff)+
geom_hist(mapping=aes(estimate))
ggplot(full.model.coeff)+
geom_histogram(mapping=aes(estimate))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(estimate))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate), stat="identity")
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
summary(full.library.model)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate), stat="identity")+
theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
summary(full.library.model)
levels(full.library.model)
levels(libraries$state)
best.stepwise.model <- glm(formula = `Total Circulation` ~ state + Locale + `Service Area Population` +
`Percentage of Children's Material Circulation` + `Branch Library` +
`Internet Computers` + `Wireless Sessions` + `Children's Program Attendance` +
`Local Revenue ($)` + `State Revenue ($)` + `Hours/Year` +
`Physical Visits` + `Registered Users` + `Inter-library Loans from Other Library`,
data = libraries, family = "gaussian")
best.stepwise.model <- glm(formula = `Total Circulation` ~ state + Locale + `Service Area Population` +
`Percentage of Children's Material Circulation` + `Branch Library` +
`Internet Computers` + `Wireless Sessions` + `Children's Program Attendance` +
`Local Revenue ($)` + `State Revenue ($)` + `Hours/Year` +
`Physical Visits` + `Registered Users` + `Inter-library Loans from Other Library`,
data = libraries, family = "gaussian")
best.stepwise.model
summary(best.stepwise.model)
levels(libraries$Locale)
libraries
summary(best.stepwise.model)
step(full.library.model, direction="both")
summary(full.library.model)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate), stat="identity")+
theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
full.model.coeff <- data.frame(
term = names(full.library.model$coefficients),
estimate = full.library.model$coefficients)|>
filter(estimate >=75)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate), stat="identity")+
theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
full.model.coeff <- data.frame(
term = names(full.library.model$coefficients),
estimate = full.library.model$coefficients)|>
filter(estimate >=75 | estimate <=-75)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(term, estimate), stat="identity")+
theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(estimate >=75 | estimate <=-75)
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-75)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-1000)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 65, vjust = 0.5, hjust=1))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 65, vjust = 0.5, hjust=0))
1
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 65, vjust = 1, hjust=1))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-1000)|>
mutate("% Circ - Children's"= "Percentage of Children's Material Circulation")
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
full.model.coeff
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
full.model.coeff
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-1000)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
full.library.model <- glm(`Total Circulation` ~ ., data = libraries, family = "gaussian")
summary(full.library.model)
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-1000)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-75)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 75, vjust = 1, hjust=1))
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))
summary(full.library.model)
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-75)
summary(full.library.model)
cv.glm(libraries, full.library.model, K=100)$delta[2]
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
ggtitle("Estimated Coefficients: Full Linear Model")
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
ggtitle("Estimated Coefficients: Full Linear Model (Training)")
full.model.coeff <- data.frame(
Variable = names(full.library.model$coefficients),
Coefficient = full.library.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-75)
ggplot(full.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
ggtitle("Estimated Coefficients: Full Linear Model (Training)")
step.model.coeff <- data.frame(
Variable = names(best.stepwise.model$coefficients),
Coefficient = best.stepwise.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-75)
ggplot(best.stepwise.model)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
ggtitle("Estimated Coefficients: Stepwise Model (Training)")
step.model.coeff <- data.frame(
Variable = names(best.stepwise.model$coefficients),
Coefficient = best.stepwise.model$coefficients)|>
filter(Coefficient >=75 | Coefficient <=-75)
ggplot(step.model.coeff)+
geom_bar(mapping=aes(Variable, Coefficient), stat="identity")+
theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=1))+
ggtitle("Estimated Coefficients: Stepwise Model (Training)")
summary(best.stepwise.model)
count(best.stepwise.model)
count(best.stepwise.model$coefficients)
(best.stepwise.model$coefficients)
best.stepwise.model$coefficients
best.stepwise.model$coefficients
summary(best.stepwise.model)
libraries
cv.glm(libraries, best.stepwise.model, K=100)$delta[2]
libraries.ridge
libraries.ridge <- cv.glmnet(x = libraries.X, y=libraries.Y, alpha=0)
libraries.ridge
libraries.ridge <- glmnet(x=libraries.X, y=libraries.Y, alpha=0)
plot(libraries.ridge)
lambda.ridge <- libraries.ridge.cv$lambda.min
libraries.ridge.cv <- cv.glmnet(x = libraries.X, y=libraries.Y, alpha=0)
lambda.ridge <- libraries.ridge.cv$lambda.min
predict(libraries.ridge, s=lambda.ridge, type="response")
predict(libraries.ridge, s=lambda.ridge, type="coefficient")
